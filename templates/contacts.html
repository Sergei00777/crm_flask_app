{% extends "base.html" %}

{% block title %}Контакты{% endblock %}
{% block page_title %}Управление контактами{% endblock %}

{% block content %}
<div class="contacts-container">
    <!-- Фильтры и поиск -->
    <div class="contacts-header">
        <div class="filters">
            <select id="category-filter" class="filter-select">
                <option value="all" {% if category_filter == 'all' %}selected{% endif %}>Все категории</option>
                <option value="client" {% if category_filter == 'client' %}selected{% endif %}>Клиенты</option>
                <option value="partner" {% if category_filter == 'partner' %}selected{% endif %}>Партнеры</option>
                <option value="supplier" {% if category_filter == 'supplier' %}selected{% endif %}>Поставщики</option>
                <option value="employee" {% if category_filter == 'employee' %}selected{% endif %}>Сотрудники</option>
            </select>

            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Поиск контактов..." value="{{ search_query }}">
            </div>
        </div>

        <button class="btn btn-primary" onclick="showContactModal()">
            <i class="fas fa-plus"></i>
            Новый контакт
        </button>
    </div>

    <!-- Список контактов -->
    <div class="contacts-list">
        {% for contact in contacts %}
        <div class="contact-card category-{{ contact.category }}" data-contact-id="{{ contact.id }}">
            <div class="contact-avatar">
                <i class="fas fa-user"></i>
            </div>

            <div class="contact-info">
                <h3 class="contact-name">{{ contact.get_full_name() }}</h3>

                <div class="contact-details">
                    {% if contact.company %}
                    <span class="contact-company">
                        <i class="fas fa-building"></i>
                        {{ contact.company }}
                        {% if contact.position %} - {{ contact.position }}{% endif %}
                    </span>
                    {% endif %}

                    {% if contact.phone %}
                    <span class="contact-phone">
                        <i class="fas fa-phone"></i>
                        {{ contact.phone }}
                    </span>
                    {% endif %}

                    {% if contact.email %}
                    <span class="contact-email">
                        <i class="fas fa-envelope"></i>
                        {{ contact.email }}
                    </span>
                    {% endif %}

                    {% if contact.get_full_address() != "Адрес не указан" %}
                    <span class="contact-address">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ contact.get_full_address() }}
                    </span>
                    {% endif %}
                </div>

                <div class="contact-meta">
                    <span class="contact-category badge category-{{ contact.category }}">
                        {% if contact.category == 'client' %}Клиент
                        {% elif contact.category == 'partner' %}Партнер
                        {% elif contact.category == 'supplier' %}Поставщик
                        {% elif contact.category == 'employee' %}Сотрудник
                        {% else %}{{ contact.category }}{% endif %}
                    </span>

                    {% if contact.birth_date %}
                    <span class="contact-birthdate">
                        <i class="fas fa-birthday-cake"></i>
                        {{ contact.birth_date.strftime('%d.%m.%Y') }}
                    </span>
                    {% endif %}
                </div>
            </div>

            <div class="contact-actions">
                <button class="btn-icon" onclick="editContact({{ contact.id }})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon" onclick="deleteContact({{ contact.id }})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-address-book"></i>
            <h3>Контакты не найдены</h3>
            <p>Создайте первый контакт или измените параметры поиска</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Модальное окно создания/редактирования контакта -->
<div id="contactModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="modalTitle">Новый контакт</h2>
            <span class="close" onclick="closeContactModal()">&times;</span>
        </div>

        <form id="contactForm" onsubmit="handleContactSubmit(event)">
            <input type="hidden" id="contactId">

            <div class="form-tabs">
                <button type="button" class="tab-btn active" data-tab="basic">Основное</button>
                <button type="button" class="tab-btn" data-tab="passport">Паспорт</button>
                <button type="button" class="tab-btn" data-tab="address">Адрес</button>
                <button type="button" class="tab-btn" data-tab="social">Соцсети</button>
                <button type="button" class="tab-btn" data-tab="notes">Заметки</button>
            </div>

            <div class="tab-content active" data-tab="basic">
                <div class="form-row">
                    <div class="form-group">
                        <label for="lastName">Фамилия *</label>
                        <input type="text" id="lastName" required>
                    </div>

                    <div class="form-group">
                        <label for="firstName">Имя *</label>
                        <input type="text" id="firstName" required>
                    </div>

                    <div class="form-group">
                        <label for="middleName">Отчество</label>
                        <input type="text" id="middleName">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Телефон</label>
                        <input type="tel" id="phone" placeholder="+7 (999) 123-45-67">
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="birthDate">Дата рождения</label>
                        <input type="date" id="birthDate">
                    </div>

                    <div class="form-group">
                        <label for="category">Категория</label>
                        <select id="category">
                            <option value="client">Клиент</option>
                            <option value="partner">Партнер</option>
                            <option value="supplier">Поставщик</option>
                            <option value="employee">Сотрудник</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="company">Компания</label>
                        <input type="text" id="company">
                    </div>

                    <div class="form-group">
                        <label for="position">Должность</label>
                        <input type="text" id="position">
                    </div>
                </div>
            </div>

            <div class="tab-content" data-tab="passport">
                <div class="form-row">
                    <div class="form-group">
                        <label for="passportSeries">Серия паспорта</label>
                        <input type="text" id="passportSeries" maxlength="4" placeholder="4510">
                    </div>

                    <div class="form-group">
                        <label for="passportNumber">Номер паспорта</label>
                        <input type="text" id="passportNumber" maxlength="6" placeholder="123456">
                    </div>
                </div>

                <div class="form-group">
                    <label for="passportIssuedBy">Кем выдан</label>
                    <input type="text" id="passportIssuedBy">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="passportIssueDate">Дата выдачи</label>
                        <input type="date" id="passportIssueDate">
                    </div>

                    <div class="form-group">
                        <label for="passportDepartmentCode">Код подразделения</label>
                        <input type="text" id="passportDepartmentCode" placeholder="770-001">
                    </div>
                </div>
            </div>

            <div class="tab-content" data-tab="address">
                <div class="form-row">
                    <div class="form-group">
                        <label for="addressIndex">Индекс</label>
                        <input type="text" id="addressIndex">
                    </div>

                    <div class="form-group">
                        <label for="addressCountry">Страна</label>
                        <input type="text" id="addressCountry">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="addressRegion">Регион/Область</label>
                        <input type="text" id="addressRegion">
                    </div>

                    <div class="form-group">
                        <label for="addressCity">Город</label>
                        <input type="text" id="addressCity">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="addressStreet">Улица</label>
                        <input type="text" id="addressStreet">
                    </div>

                    <div class="form-group">
                        <label for="addressHouse">Дом</label>
                        <input type="text" id="addressHouse">
                    </div>

                    <div class="form-group">
                        <label for="addressApartment">Квартира</label>
                        <input type="text" id="addressApartment">
                    </div>
                </div>
            </div>

            <div class="tab-content" data-tab="social">
                <div class="form-group">
                    <label for="socialTelegram">Telegram</label>
                    <input type="text" id="socialTelegram" placeholder="@username">
                </div>

                <div class="form-group">
                    <label for="socialWhatsapp">WhatsApp</label>
                    <input type="text" id="socialWhatsapp" placeholder="+79991234567">
                </div>

                <div class="form-group">
                    <label for="socialVk">ВКонтакте</label>
                    <input type="text" id="socialVk" placeholder="id123456789 или username">
                </div>
            </div>

            <div class="tab-content" data-tab="notes">
                <div class="form-group">
                    <label for="notes">Заметки</label>
                    <textarea id="notes" rows="5" placeholder="Дополнительная информация о контакте..."></textarea>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeContactModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
.contacts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 15px;
    flex-wrap: wrap;
}

.contacts-header .filters {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.contacts-header .search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.contacts-header .search-box i {
    position: absolute;
    left: 15px;
    color: var(--gray);
}

.contacts-header .search-box input {
    padding: 10px 15px 10px 40px;
    border: 1px solid #e0e0e0;
    border-radius: var(--border-radius);
    width: 250px;
    font-size: 0.9rem;
}

.contacts-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.contact-card {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 20px;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.contact-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.contact-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--gray);
    flex-shrink: 0;
}

.contact-info {
    flex: 1;
}

.contact-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--dark);
}

.contact-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.contact-details span {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--gray);
}

.contact-details i {
    width: 16px;
}

.contact-meta {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.contact-category {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
}

.category-client { background: #e3f2fd; color: #1976d2; }
.category-partner { background: #e8f5e9; color: #2e7d32; }
.category-supplier { background: #fff3e0; color: #f57c00; }
.category-employee { background: #f3e5f5; color: #7b1fa2; }

.contact-birthdate {
    font-size: 0.9rem;
    color: var(--gray);
    display: flex;
    align-items: center;
    gap: 5px;
}

.contact-actions {
    display: flex;
    gap: 5px;
}

/* Табы в модальном окне */
.form-tabs {
    display: flex;
    border-bottom: 1px solid #e0e0e0;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    color: var(--gray);
    transition: all 0.3s ease;
}

.tab-btn:hover {
    color: var(--primary);
}

.tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

.tab-content {
    display: none;
    max-height: 400px;
    overflow-y: auto;
    padding: 5px;
}

.tab-content.active {
    display: block;
}

@media (max-width: 768px) {
    .contacts-header {
        flex-direction: column;
        align-items: stretch;
    }

    .contacts-header .filters {
        flex-direction: column;
        align-items: stretch;
    }

    .contacts-header .search-box input {
        width: 100%;
    }

    .contact-card {
        flex-direction: column;
        align-items: stretch;
    }

    .contact-avatar {
        align-self: center;
    }

    .contact-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .form-tabs {
        flex-wrap: wrap;
    }

    .tab-btn {
        flex: 1;
        min-width: 80px;
        text-align: center;
        font-size: 0.8rem;
        padding: 8px 12px;
    }
}
</style>

<script>
// Табы в модальном окне
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Деактивируем все табы
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Активируем выбранный таб
        this.classList.add('active');
        const tabName = this.dataset.tab;
        document.querySelector(`.tab-content[data-tab="${tabName}"]`).classList.add('active');
    });
});

// Поиск контактов
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});

document.getElementById('category-filter').addEventListener('change', function() {
    applyFilters();
});

function applyFilters() {
    const category = document.getElementById('category-filter').value;
    const search = document.getElementById('search-input').value;

    const url = new URL(window.location);
    url.searchParams.set('category', category);
    if (search) {
        url.searchParams.set('search', search);
    } else {
        url.searchParams.delete('search');
    }

    window.location.href = url.toString();
}

// Работа с модальным окном контакта
let currentContactId = null;

function showContactModal(contactId = null) {
    currentContactId = contactId;
    const modal = document.getElementById('contactModal');
    const title = document.getElementById('modalTitle');

    // Сброс табов к первому
    document.querySelectorAll('.tab-btn').forEach((btn, index) => {
        if (index === 0) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    document.querySelectorAll('.tab-content').forEach((content, index) => {
        if (index === 0) {
            content.classList.add('active');
        } else {
            content.classList.remove('active');
        }
    });

    if (contactId) {
        title.textContent = 'Редактировать контакт';
        loadContactData(contactId);
    } else {
        title.textContent = 'Новый контакт';
        document.getElementById('contactForm').reset();
        document.getElementById('contactId').value = '';
        document.getElementById('category').value = 'client';
    }

    modal.style.display = 'block';
}

function closeContactModal() {
    document.getElementById('contactModal').style.display = 'none';
    currentContactId = null;
}

function loadContactData(contactId) {
    fetch(`/api/contacts/${contactId}`)
        .then(response => response.json())
        .then(contact => {
            document.getElementById('contactId').value = contact.id;
            document.getElementById('firstName').value = contact.first_name;
            document.getElementById('lastName').value = contact.last_name;
            document.getElementById('middleName').value = contact.middle_name || '';
            document.getElementById('phone').value = contact.phone || '';
            document.getElementById('email').value = contact.email || '';
            document.getElementById('company').value = contact.company || '';
            document.getElementById('position').value = contact.position || '';
            document.getElementById('category').value = contact.category;

            // Даты
            document.getElementById('birthDate').value = contact.birth_date || '';
            document.getElementById('passportIssueDate').value = contact.passport_issue_date || '';

            // Паспортные данные
            document.getElementById('passportSeries').value = contact.passport_series || '';
            document.getElementById('passportNumber').value = contact.passport_number || '';
            document.getElementById('passportIssuedBy').value = contact.passport_issued_by || '';
            document.getElementById('passportDepartmentCode').value = contact.passport_department_code || '';

            // Адрес
            document.getElementById('addressIndex').value = contact.address_index || '';
            document.getElementById('addressCountry').value = contact.address_country || '';
            document.getElementById('addressRegion').value = contact.address_region || '';
            document.getElementById('addressCity').value = contact.address_city || '';
            document.getElementById('addressStreet').value = contact.address_street || '';
            document.getElementById('addressHouse').value = contact.address_house || '';
            document.getElementById('addressApartment').value = contact.address_apartment || '';

            // Соцсети
            document.getElementById('socialTelegram').value = contact.social_telegram || '';
            document.getElementById('socialWhatsapp').value = contact.social_whatsapp || '';
            document.getElementById('socialVk').value = contact.social_vk || '';

            // Заметки
            document.getElementById('notes').value = contact.notes || '';
        })
        .catch(error => console.error('Error loading contact:', error));
}

function handleContactSubmit(event) {
    event.preventDefault();

    const formData = {
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        middle_name: document.getElementById('middleName').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        company: document.getElementById('company').value,
        position: document.getElementById('position').value,
        category: document.getElementById('category').value,
        birth_date: document.getElementById('birthDate').value,
        passport_series: document.getElementById('passportSeries').value,
        passport_number: document.getElementById('passportNumber').value,
        passport_issued_by: document.getElementById('passportIssuedBy').value,
        passport_issue_date: document.getElementById('passportIssueDate').value,
        passport_department_code: document.getElementById('passportDepartmentCode').value,
        address_index: document.getElementById('addressIndex').value,
        address_country: document.getElementById('addressCountry').value,
        address_region: document.getElementById('addressRegion').value,
        address_city: document.getElementById('addressCity').value,
        address_street: document.getElementById('addressStreet').value,
        address_house: document.getElementById('addressHouse').value,
        address_apartment: document.getElementById('addressApartment').value,
        social_telegram: document.getElementById('socialTelegram').value,
        social_whatsapp: document.getElementById('socialWhatsapp').value,
        social_vk: document.getElementById('socialVk').value,
        notes: document.getElementById('notes').value
    };

    const url = currentContactId ? `/api/contacts/${currentContactId}` : '/api/contacts';
    const method = currentContactId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            closeContactModal();
            window.location.reload();
        } else {
            throw new Error('Ошибка сохранения контакта');
        }
    })
    .catch(error => {
        alert('Ошибка: ' + error.message);
    });
}

function editContact(contactId) {
    showContactModal(contactId);
}

function deleteContact(contactId) {
    if (confirm('Вы уверены, что хотите удалить этот контакт?')) {
        fetch(`/api/contacts/${contactId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                throw new Error('Ошибка удаления контакта');
            }
        })
        .catch(error => {
            alert('Ошибка: ' + error.message);
        });
    }
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
    const modal = document.getElementById('contactModal');
    if (event.target === modal) {
        closeContactModal();
    }
};
</script>
{% endblock %}